---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<div class="formulario-kommo-container">
  <form id="formulario-kommo" class="space-y-4">
    <div>
      <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">
        {t('form.name')}
      </label>
      <input
        type="text"
        id="nombre"
        name="nombre"
        required
        placeholder={t('form.name.placeholder')}
        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all"
      />
    </div>

    <div>
      <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">
        {t('form.phone')}
      </label>
      <input
        type="tel"
        id="telefono"
        name="telefono"
        required
        placeholder={t('form.phone.placeholder')}
        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all"
      />
    </div>

    <div>
      <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
        {t('form.email')}
      </label>
      <input
        type="email"
        id="email"
        name="email"
        required
        placeholder={t('form.email.placeholder')}
        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all"
      />
    </div>

    <div>
      <label for="empresa" class="block text-sm font-medium text-gray-700 mb-1">
        {t('form.company')}
      </label>
      <input
        type="text"
        id="empresa"
        name="empresa"
        placeholder={t('form.company.placeholder')}
        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all"
      />
    </div>

    <div>
      <label for="sucursal" class="block text-sm font-medium text-gray-700 mb-1">
        {t('form.branch')}
      </label>
      <select
        id="sucursal"
        name="sucursal"
        required
        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all bg-white"
      >
        <option value="">{t('form.branch.placeholder')}</option>
        <option value="VH">{t('form.branch.vh')}</option>
        <option value="RA">{t('form.branch.ra')}</option>
        <option value="AL">{t('form.branch.al')}</option>
        <option value="SA">{t('form.branch.sa')}</option>
        <option value="M8">{t('form.branch.m8')}</option>
        <option value="CO">{t('form.branch.co')}</option>
        <option value="GO">{t('form.branch.go')}</option>
        <option value="DA">{t('form.branch.da')}</option>
        <option value="CE">{t('form.branch.ce')}</option>
        <option value="HM">{t('form.branch.hm')}</option>
        <option value="TM">{t('form.branch.tm')}</option>
      </select>
    </div>

    <button
      type="submit"
      id="submit-button"
      class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-3 px-6 rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all duration-300 transform hover:scale-[1.02] shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <span id="button-text">{t('form.submit')}</span>
    </button>

    <div id="form-message" class="hidden p-4 rounded-lg text-center"></div>
  </form>
</div>

<script>
  const form = document.getElementById('formulario-kommo') as HTMLFormElement;
  const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
  const buttonText = document.getElementById('button-text') as HTMLSpanElement;
  const formMessage = document.getElementById('form-message') as HTMLDivElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    submitButton.disabled = true;
    buttonText.textContent = submitButton.getAttribute('data-sending') || 'Enviando...';
    formMessage.classList.add('hidden');

    const formData = new FormData(form);
    const data = {
      nombre: formData.get('nombre') as string,
      telefono: formData.get('telefono') as string,
      email: formData.get('email') as string,
      empresa: formData.get('empresa') as string,
      sucursal: formData.get('sucursal') as string,
    };

    try {
      const response = await fetch('/api/contact', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok && result.success) {
        formMessage.className = 'p-4 rounded-lg text-center bg-green-50 border border-green-200 text-green-800';
        formMessage.innerHTML = `
          <div class="flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <strong>${submitButton.getAttribute('data-success') || '¡Cotización enviada!'}</strong>
          </div>
          <p class="mt-2 text-sm">${submitButton.getAttribute('data-success-msg') || 'Gracias por tu interés. Te contactaremos pronto.'}</p>
        `;
        formMessage.classList.remove('hidden');
        form.reset();

        setTimeout(() => {
          const thankYouPage = window.location.pathname.includes('/en') 
            ? '/en/thank-you-quote' 
            : '/gracias-cotizacion';
          window.location.href = thankYouPage;
        }, 2000);

      } else {
        throw new Error(result.error || 'Error al enviar el formulario');
      }

    } catch (error) {
      console.error('Error:', error);
      formMessage.className = 'p-4 rounded-lg text-center bg-red-50 border border-red-200 text-red-800';
      formMessage.innerHTML = `
        <div class="flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          <strong>${submitButton.getAttribute('data-error') || 'Error al enviar'}</strong>
        </div>
        <p class="mt-2 text-sm">${submitButton.getAttribute('data-error-msg') || 'Por favor intenta nuevamente o contáctanos directamente.'}</p>
      `;
      formMessage.classList.remove('hidden');
    } finally {
      submitButton.disabled = false;
      buttonText.textContent = submitButton.getAttribute('data-submit') || 'Solicitar cotización';
    }
  });

  document.addEventListener('astro:page-load', () => {
    const currentLang = document.documentElement.lang || 'es';
    const translations = {
      es: {
        submit: 'Solicitar cotización',
        sending: 'Enviando...',
        success: '¡Cotización enviada!',
        successMsg: 'Gracias por tu interés. Te contactaremos pronto.',
        error: 'Error al enviar',
        errorMsg: 'Por favor intenta nuevamente o contáctanos directamente.'
      },
      en: {
        submit: 'Request quote',
        sending: 'Sending...',
        success: 'Quote sent!',
        successMsg: 'Thank you for your interest. We will contact you soon.',
        error: 'Error sending',
        errorMsg: 'Please try again or contact us directly.'
      }
    };

    const t = translations[currentLang as keyof typeof translations] || translations.es;
    
    const btn = document.getElementById('submit-button');
    if (btn) {
      btn.setAttribute('data-submit', t.submit);
      btn.setAttribute('data-sending', t.sending);
      btn.setAttribute('data-success', t.success);
      btn.setAttribute('data-success-msg', t.successMsg);
      btn.setAttribute('data-error', t.error);
      btn.setAttribute('data-error-msg', t.errorMsg);
    }
  });
</script>

<style>
  .formulario-kommo-container {
    width: 100%;
  }

  input:focus,
  select:focus {
    outline: none;
  }

  @media (max-width: 640px) {
    .formulario-kommo-container {
      font-size: 14px;
    }
  }
</style>
